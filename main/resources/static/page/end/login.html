<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta HTTP-EQUIV="pragma" CONTENT="no-cache">
    <meta HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">
    <meta HTTP-EQUIV="expires" CONTENT="0">
    <title>登录</title>
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/element.css">
    <link rel="stylesheet" href="../../css/style.css">

<!--    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
          integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    &lt;!&ndash; jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) &ndash;&gt;
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"
            integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ"
            crossorigin="anonymous"></script>
    &lt;!&ndash; 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 &ndash;&gt;
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
            integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
            crossorigin="anonymous"></script>&ndash;&gt;-->
</head>
<!--<body style="background:url('../../images/bg4.png') no-repeat; background-size: cover; background-color: lightgoldenrodyellow">-->
<!--    <div style="background:url('../../images/bg5.png') no-repeat; position: fixed;top: 0;width: 100%;height: 200px"></div>-->
<!--<div id="wrapper">
    <div style="width: 400px; margin: 120px auto; background-color:rgba(100,149,237,0.5); border-radius: 10px">
&lt;!&ndash;        <div style="width: 400px; margin: 120px auto; background-color:rgba(100,150,237,0.46); border-radius: 10px">&ndash;&gt;
        <div style="width: 100%; height: 100px; font-size: 30px;line-height: 100px; text-align: center; color: #f5f2f2">欢迎登录</div>
        <div style="margin-top: 25px; width: 100%; height: 320px;">
            <div style="width: 60%; margin: 0 auto">
                <span class="glyphicon glyphicon-user" style="width: 10%"></span><input v-model="user.username" type="text" style="border: 1px solid #cccccc; height: 40px; padding: 10px; width: 90%" placeholder="请输入账号">
                <span class="glyphicon glyphicon-lock" style="width: 10%"></span><input v-model="user.password" type="password" style="border: 1px solid #ccc; height: 40px; padding: 10px; width: 90%; margin-top: 25px" placeholder="请输入密码">
                <div style="margin-top: 25px; line-height: 0px">
                    <span class="glyphicon glyphicon-leaf" style="width: 10%"></span><input v-model="user.code" type="text" style="border: 1px solid #ccc; padding: 10px; width: 55%; " placeholder="请输入验证码">
                    <div id="picyzm" style="display: inline-block; height: 35px; vertical-align: middle; width: 33%"></div>
                </div>

                <button @click="login" style="height: 40px; padding: 10px; width: 100%; margin-top: 25px; background-color: mediumseagreen; color: white">登录</button>
                <a style="/*width: 100%;*/ text-align: right; display: inline-block; margin-top: 25px; color: #eee" href="register.html">还没账号？去注册</a>
                <a style="float: right; display: inline-block; margin-top: 25px; color: #eee" href="./reset.html">忘记密码？</a>
            </div>

        </div>
    </div>
</div>-->
<body>
<div class="container" id="wrapper">
    <div class="form-warp">
        <form class="sign-in-form" id="in">
            <h2 class="form-title">登录</h2>
            <input v-model="user.username" placeholder="用户名"/>
            <input v-model="user.password" type="password" placeholder="密码"/>
            <input v-model="user.code" type="text" placeholder="验证码" @keydown.enter="login"/>
            <div id="picyzm" style="display: inline-block; height: 35px; vertical-align: middle; width: 33%"></div>
            <div class="submit-btn" @click="login">立即登录</div>
        </form>
        <form class="sign-up-form" id="up">
            <h2 class="form-title">注册</h2>
            <input v-model="user.username" placeholder="用户名 "/><i style="color: #cccc">{{usernameMsg}}</i>
            <input v-model="user.password" type="password" placeholder="密码"/><i style="color: #cccc">{{passwordMsg}}</i>
            <input v-model="password" type="password" placeholder="确认密码"/>
            <select v-model="user.question" name="question" id="question">
                <option value="none" selected disabled hidden>请选择密保问题</option>
                <option value="favoritebook">你最喜欢的书是哪本</option>
                <option value="favoritewriter">你最喜欢的作家是谁</option>
                <option value="mypet">你宠物的名字是什么</option>
                <option value="myfriend">说出你的一个好朋友</option>
            </select>
            <input v-model="user.answers" type="text" placeholder="请输入密保答案" @keydown.enter="register">
            <div class="submit-btn" @click="register">立即注册</div>
        </form>
        <form class="sign-forget-form" id="forget">
            <h2 class="form-title">忘记密码</h2>
            <input v-model="user.username" placeholder="用户名"/>
            <input v-model="user.password" type="password" placeholder="新密码" @keydown.enter="reset"/><i style="color: #cccc">{{passwordMsg}}</i>
            <select v-model="user.question" name="question" id="questions">
                <option value="none" selected disabled hidden>请选择密保问题</option>
                <option value="favoritebook">你最喜欢的书是哪本</option>
                <option value="favoritewriter">你最喜欢的作家是谁</option>
                <option value="mypet">你宠物的名字是什么</option>
                <option value="myfriend">说出你的一个好朋友</option>
            </select>
            <input v-model="user.answers" type="text" placeholder="请输入密保答案">
            <div class="submit-btn" @click="reset">立即修改</div>
        </form>
    </div>
    <div class="desc-warp">
        <div class="desc-warp-item sign-up-desc">
            <div class="content">
                <button id="sign-up-btn">注册</button>
                <button id="sign-forget-btn">忘记密码</button>
            </div>
            <img src="../../images/log.svg" alt="">
        </div>
        <div class="desc-warp-item sign-in-desc">
            <div class="content">
                <button id="sign-in-btn">登录</button>
            </div>
            <img src="../../images/register.svg" alt="">
        </div>
    </div>
</div>

<script src="../../js/jquery.min.js"></script>
<script src="../../js/vue.min.js"></script>
<script src="../../js/element.js"></script>
<script src="../../js/gVerify.js"></script>
<!--<script src="../../js/bootstrap.min.js"></script>-->

<script>
    window.onload = function(){
        var singUpBtn = document.getElementById("sign-up-btn");
        var singInBtn = document.getElementById("sign-in-btn");
        var singForgetBtn = document.getElementById("sign-forget-btn");
        var container = document.getElementById("wrapper");

        singUpBtn.onclick = function () {
            container.classList.add('sign-up-mode');
        }
        singInBtn.onclick = function () {
            container.classList.remove('sign-up-mode')
            container.classList.remove('sign-forget-mode')
        }
        singForgetBtn.onclick = function () {
            container.classList.add('sign-forget-mode')
        }
    }
</script>

<script>
    //初始化验证码
    let verifyCode;

    new Vue({
        el: "#wrapper",
        data: {
            user: {
                question:"none",
            },
            passwordMsg:"/*由数字、字母和符号组成，长度为6-20位/",
            usernameMsg:"/*由数字、字母和下划线组成，长度为6-20位/",
            password:"",
        },
        mounted() {
            verifyCode = new GVerify({
                id: "picyzm",
                type: "blend"
            });
        },
        methods: {
            login() {
                if (!this.user.username) {
                    this.$message({
                        message: "请输入用户名",
                        type: "error"
                    });
                    return;
                }
                if (!this.user.password) {
                    this.$message({
                        message: "请输入密码",
                        type: "error"
                    });
                    return;
                }
                if (!this.user.code) {
                    this.$message({
                        message: "请输入验证码",
                        type: "error"
                    });
                    return;
                }
                let res = verifyCode.validate(this.user.code);
                if (!res) {
                    this.$message({
                        message: "验证码错误",
                        type: "error"
                    });
                    return;
                }
                $.ajax({
                    url: "/api/user/login",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(this.user)
                }).then(res => {
                    if (res.code === '0') {
                        this.$message({
                            message: "登录成功",
                            type: "success"
                        });
                        sessionStorage.setItem("user", JSON.stringify(res.data));
                        setTimeout(() => {
                            location.href = "frames.html"
                            if (JSON.stringify(res.data.role).includes('1')) {
                                location.href = "frame.html"
                            } else {
                                location.href = "/page/end/frame.html"
                            }
                        }, 1000)
                    } else {
                        this.$message({
                            message: res.msg,
                            type: "error"
                        })
                    }
                })
            },
            register() {
                var n = /^\w{6,20}$/;
                var p = /^\S{6,20}$/;
                var sp = /^[0-9]{6,20}$/;
                if (!this.user.username) {
                    this.$message({
                        message: "请输入用户名",
                        type: "error"
                    });
                    return;
                }
                if(!this.user.username.match(n)){
                    this.$message({
                        message: "用户名不规范",
                        type: "error"
                    });
                    return;
                }
                if (!this.user.password) {
                    this.$message({
                        message: "请输入密码",
                        type: "error"
                    });
                    return;
                }
                if(!this.user.password.match(p)){
                    this.$message({
                        message: "密码格式不规范",
                        type: "error"
                    });
                    return;
                }
                if(this.user.password.match(sp)){
                    this.$message({
                        message: "密码太简单了哦，加上字母试试吧",
                        type: "error"
                    });
                    return;
                }
                console.log(this.user.password===this.password)
                if (this.password=="") {
                    this.$message({
                        message: "请再次输入密码",
                        type: "error"
                    });
                    return;
                }
                if(!(this.user.password===this.password)){
                    this.$message({
                        message: "两次输入的密码不一致",
                        type: "error"
                    });
                    return;
                }
                if(this.user.question=="none"){
                    this.$message({
                        message: "请选择密保问题",
                        type: "error"
                    });
                    return;
                }
                if(!this.user.answers){
                    this.$message({
                        message: "请输入密保答案",
                        type: "error"
                    });
                    return;
                }
                $.ajax({
                    url: "/api/user/register",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(this.user)
                }).then(res => {
                    if (res.code === '0') {
                        this.$message({
                            message: "注册成功",
                            type: "success"
                        });
                        sessionStorage.setItem("user", JSON.stringify(res.data));
                        setTimeout(() => {
                            location.href= "/page/end/login.html"
                        }, 1000)
                    } else {
                        this.$message({
                            message: res.msg,
                            type: "error"
                        })
                    }
                })
            },
            reset(){
                var p = /^\S{6,20}$/;
                var sp = /^[0-9]{6,20}$/;
                if(!this.user.username){
                    this.$message({
                        message:"请输入用户名",
                        type:"error"
                    });
                    return;
                }
                if(this.user.question=="none"){
                    this.$message({
                        message: "请选择密保问题",
                        type: "error"
                    });
                    return;
                }
                if(!this.user.answers){
                    this.$message({
                        message: "请输入密保答案",
                        type: "error"
                    });
                    return;
                }
                if(!this.user.password){
                    this.$message({
                        message:"请输入新密码",
                        type:"error"
                    });
                    return;
                }
                if(!this.user.password.match(p)){
                    this.$message({
                        message: "密码格式不规范",
                        type: "error"
                    });
                    return;
                }
                if(this.user.password.match(sp)){
                    this.$message({
                        message: "密码太简单了哦，加上字母试试吧",
                        type: "error"
                    });
                    return;
                }
                console.log("----------");
                $.ajax({
                    url:"/api/user/reset",
                    type:"POST",
                    contentType: "application/json",
                    data: JSON.stringify(this.user)
                }).then(res=>{
                    if(res.code=='0'){
                        this.$message({
                            message: "修改成功",
                            type: "success"
                        });
                        sessionStorage.setItem("user", JSON.stringify(res.data));
                        setTimeout(() => {
                            location.href= "/page/end/login.html"
                        }, 1000);
                    }else {
                        this.$message({
                            message: res.msg,
                            type: "error"
                        })
                    }
                })
            },
        }
    })
</script>
</body>
</html>
